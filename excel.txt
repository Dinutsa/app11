"""
–ú–æ–¥—É–ª—å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è Excel-–∑–≤—ñ—Ç—É –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.

–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—ñ–≤ —É —Ñ–æ—Ä–º–∞—Ç—ñ XLSX –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–∞–∫—Ç–∏—Ü—ñ –¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è
—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å —É –ó–í–û —Ç–∞ –≤–∏–º–æ–≥–∞–º –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö
—Å–∏—Å—Ç–µ–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –æ—Å–≤—ñ—Ç–∏.
"""

from __future__ import annotations

import io
from typing import Dict, List

import pandas as pd

from classification import QuestionInfo
from summary import QuestionSummary


def build_excel_report(
    original_df: pd.DataFrame,
    sliced_df: pd.DataFrame,
    qinfo: Dict[str, QuestionInfo],
    summaries: List[QuestionSummary],
    range_info: str,
) -> bytes:
    """
    –°—Ç–≤–æ—Ä—é—î Excel-–∑–≤—ñ—Ç —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î –π–æ–≥–æ —É –≤–∏–≥–ª—è–¥—ñ –±–∞–π—Ç—ñ–≤ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

    :param original_df: –ø–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.
    :param sliced_df: –≤–∏–±—Ä–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –¥—ñ–∞–ø–∞–∑–æ–Ω.
    :param qinfo: —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∏—Ç–∞–Ω–Ω—è.
    :param summaries: —Å–ø–∏—Å–æ–∫ –∑–≤–µ–¥–µ–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å.
    :param range_info: —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å –¥—ñ–∞–ø–∞–∑–æ–Ω—É (–¥–ª—è —Ç–∏—Ç—É–ª—É).
    """
    output = io.BytesIO()

    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        # 1. –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
        meta_df = pd.DataFrame(
            {
                "–ü–∞—Ä–∞–º–µ—Ç—Ä": [
                    "–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π",
                    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π —É –≤–∏–±—Ä–∞–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ",
                    "–î—ñ–∞–ø–∞–∑–æ–Ω –æ–±—Ä–æ–±–∫–∏",
                ],
                "–ó–Ω–∞—á–µ–Ω–Ω—è": [
                    len(original_df),
                    len(sliced_df),
                    range_info,
                ],
            }
        )
        meta_df.to_excel(writer, sheet_name="–¢–µ—Ö–Ω—ñ—á–Ω–∞_—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", index=False)

        # 2. –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (—Å–∫–æ—Ä–æ—á–µ–Ω–æ)
        sliced_df.to_excel(writer, sheet_name="–í–∏—Ö—ñ–¥–Ω—ñ_–¥–∞–Ω—ñ", index=False)

        # 3. –¢–∞–±–ª–∏—Ü—ñ –ø—ñ–¥—Å—É–º–∫—ñ–≤ (–ø–æ –≤—Å—ñ—Ö –ø–∏—Ç–∞–Ω–Ω—è—Ö)
        workbook = writer.book
        ws = workbook.add_worksheet("–ü—ñ–¥—Å—É–º–∫–∏")
        writer.sheets["–ü—ñ–¥—Å—É–º–∫–∏"] = ws

        row = 0
        for qs in summaries:
            ws.write(row, 0, f"{qs.question.code}. {qs.question.text}")
            row += 1
            # –∑–∞–ø–∏—Å—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            qs.table.to_excel(
                writer,
                sheet_name="–ü—ñ–¥—Å—É–º–∫–∏",
                startrow=row,
                startcol=0,
                index=False,
                header=True,
            )
            row += len(qs.table) + 2  # –≤—ñ–¥—Å—Ç—É–ø –º—ñ–∂ –±–ª–æ–∫–∞–º–∏
        chart = workbook.add_chart({'type': 'pie'})
        chart.add_series({
            'name':       [sheet_name, 0, 0],  # –ù–∞–∑–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∏
            'categories': [sheet_name, 1, 0, 5, 0],  # –î—ñ–∞–ø–∞–∑–æ–Ω –ø—ñ–¥–ø–∏—Å—ñ–≤
            'values':     [sheet_name, 1, 1, 5, 1],  # –î—ñ–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω—å
            })
        ws.insert_chart('E2', chart)

    output.seek(0)
    return output.read()


///////////////////////////////////////////////////////////////////////////////////////////////////////////
"""
–ú–æ–¥—É–ª—å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è Excel-–∑–≤—ñ—Ç—É –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.

–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—ñ–≤ —É —Ñ–æ—Ä–º–∞—Ç—ñ XLSX –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–∞–∫—Ç–∏—Ü—ñ –¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è
—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å —É –ó–í–û —Ç–∞ –≤–∏–º–æ–≥–∞–º –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö
—Å–∏—Å—Ç–µ–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –æ—Å–≤—ñ—Ç–∏.
"""

from __future__ import annotations

import io
from typing import Dict, List

import pandas as pd

from classification import QuestionInfo
from summary import QuestionSummary


def build_excel_report(
    original_df: pd.DataFrame,
    sliced_df: pd.DataFrame,
    qinfo: Dict[str, QuestionInfo],
    summaries: List[QuestionSummary],
    range_info: str,
) -> bytes:
    """
    –°—Ç–≤–æ—Ä—é—î Excel-–∑–≤—ñ—Ç —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î –π–æ–≥–æ —É –≤–∏–≥–ª—è–¥—ñ –±–∞–π—Ç—ñ–≤ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
    –î–æ–¥–∞—î –∫—Ä—É–≥–æ–≤—ñ –¥—ñ–∞–≥—Ä–∞–º–∏ –¥–ª—è –ø–∏—Ç–∞–Ω—å, —â–æ –º–∞—é—Ç—å –∑–≤–µ–¥–µ–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ.

    :param original_df: –ø–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.
    :param sliced_df: –≤–∏–±—Ä–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –¥—ñ–∞–ø–∞–∑–æ–Ω.
    :param qinfo: —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∏—Ç–∞–Ω–Ω—è.
    :param summaries: —Å–ø–∏—Å–æ–∫ –∑–≤–µ–¥–µ–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å.
    :param range_info: —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å –¥—ñ–∞–ø–∞–∑–æ–Ω—É (–¥–ª—è —Ç–∏—Ç—É–ª—É).
    """
    output = io.BytesIO()

    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ engine="xlsxwriter", –±–æ –≤—ñ–Ω –ø—ñ–¥—Ç—Ä–∏–º—É—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥—ñ–∞–≥—Ä–∞–º
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        # --- 1. –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è ---
        meta_df = pd.DataFrame(
            {
                "–ü–∞—Ä–∞–º–µ—Ç—Ä": [
                    "–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–Ω–∫–µ—Ç —É —Ñ–∞–π–ª—ñ",
                    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–Ω–∫–µ—Ç —É –≤–∏–±—Ä–∞–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ",
                    "–î—ñ–∞–ø–∞–∑–æ–Ω –æ–±—Ä–æ–±–∫–∏",
                ],
                "–ó–Ω–∞—á–µ–Ω–Ω—è": [
                    len(original_df),
                    len(sliced_df),
                    range_info,
                ],
            }
        )
        meta_df.to_excel(writer, sheet_name="–¢–µ—Ö–Ω—ñ—á–Ω–∞_—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", index=False)

        # –ü—ñ–¥–ª–∞—à—Ç—É—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∫—Ä–∞—Å–∏
        workbook = writer.book
        worksheet_meta = writer.sheets["–¢–µ—Ö–Ω—ñ—á–Ω–∞_—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"]
        worksheet_meta.set_column("A:A", 40)
        worksheet_meta.set_column("B:B", 50)

        # --- 2. –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (—Å–∫–æ—Ä–æ—á–µ–Ω–æ/—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ) ---
        sliced_df.to_excel(writer, sheet_name="–í–∏—Ö—ñ–¥–Ω—ñ_–¥–∞–Ω—ñ", index=False)

        # --- 3. –¢–∞–±–ª–∏—Ü—ñ –ø—ñ–¥—Å—É–º–∫—ñ–≤ —Ç–∞ –¥—ñ–∞–≥—Ä–∞–º–∏ ---
        sheet_name_summary = "–ü—ñ–¥—Å—É–º–∫–∏"
        ws = workbook.add_worksheet(sheet_name_summary)
        writer.sheets[sheet_name_summary] = ws

        # –§–æ—Ä–º–∞—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤ –ø–∏—Ç–∞–Ω—å
        bold_fmt = workbook.add_format({"bold": True, "font_size": 11})
        
        # –ó–∞–¥–∞—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø—ñ–¥—Å—É–º–∫—ñ–≤
        ws.set_column("A:A", 40)  # –í–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        ws.set_column("B:C", 10)  # –ß–∏—Å–ª–∞ —Ç–∞ %

        current_row = 0

        for qs in summaries:
            question_title = f"{qs.question.code}. {qs.question.text}"
            
            # 1. –ó–∞–ø–∏—Å—É—î–º–æ –Ω–∞–∑–≤—É –ø–∏—Ç–∞–Ω–Ω—è
            ws.write(current_row, 0, question_title, bold_fmt)
            current_row += 1

            # –Ø–∫—â–æ —Ç–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥–∫—Ä–∏—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö)
            if qs.table.empty:
                ws.write(current_row, 0, "(–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –¥—ñ–∞–≥—Ä–∞–º–∏ –∞–±–æ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è)")
                current_row += 2
                continue

            # 2. –ó–∞–ø–∏—Å—É—î–º–æ —Ç–∞–±–ª–∏—Ü—é –¥–∞–Ω–∏—Ö
            # qs.table –º–∞—î –∫–æ–ª–æ–Ω–∫–∏: ["–í–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ", "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", "%"]
            # startrow=current_row, startcol=0
            qs.table.to_excel(
                writer,
                sheet_name=sheet_name_summary,
                startrow=current_row,
                startcol=0,
                index=False,
                header=True,
            )

            # –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–∞–Ω–∏—Ö –¥–ª—è –¥—ñ–∞–≥—Ä–∞–º–∏
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ –∑–∞–π–º–∞—î 1 —Ä—è–¥–æ–∫, —Ç–æ–º—É –¥–∞–Ω—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ current_row + 1
            n_rows = len(qs.table)
            first_data_row = current_row + 1
            last_data_row = current_row + n_rows

            # –ö–æ–ª–æ–Ω–∫–∏ (0-based): A=0 (Labels), B=1 (Values)
            
            # 3. –°—Ç–≤–æ—Ä—é—î–º–æ –¥—ñ–∞–≥—Ä–∞–º—É
            chart = workbook.add_chart({"type": "pie"})
            
            chart.add_series({
                "name": "–ö—ñ–ª—å–∫—ñ—Å—Ç—å",
                # [sheetname, first_row, first_col, last_row, last_col]
                "categories": [sheet_name_summary, first_data_row, 0, last_data_row, 0],
                "values":     [sheet_name_summary, first_data_row, 1, last_data_row, 1],
                "data_labels": {"percentage": True},  # –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –≤—ñ–¥—Å–æ—Ç–∫–∏ –Ω–∞ –¥—ñ–∞–≥—Ä–∞–º—ñ
            })
            
            chart.set_title({"name": question_title})
            chart.set_style(10)  # –°—Ç–∏–ª—å –¥—ñ–∞–≥—Ä–∞–º–∏ (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ 1-48)

            # 4. –í—Å—Ç–∞–≤–ª—è—î–º–æ –¥—ñ–∞–≥—Ä–∞–º—É –ø—Ä–∞–≤–æ—Ä—É—á –≤—ñ–¥ —Ç–∞–±–ª–∏—Ü—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–ª–æ–Ω–∫–∞ E, —ñ–Ω–¥–µ–∫—Å 4)
            # –í—Å—Ç–∞–≤–ª—è—î–º–æ —Ç—Ä–æ—Ö–∏ –≤–∏—â–µ (–Ω–∞ —Ä—ñ–≤–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫—É –ø–∏—Ç–∞–Ω–Ω—è), —â–æ–± –±—É–ª–æ –∫–æ–º–ø–∞–∫—Ç–Ω–æ
            ws.insert_chart(current_row - 1, 4, chart)

            # 5. –ó—Å—É–≤–∞—î–º–æ –∫—É—Ä—Å–æ—Ä –≤–Ω–∏–∑
            # –ù–∞–º —Ç—Ä–µ–±–∞ –≤—ñ–¥—Å—Ç—É–ø–∏—Ç–∏ –º—ñ—Å—Ü–µ –∞–±–æ –ø—ñ–¥ —Ç–∞–±–ª–∏—Ü—é, –∞–±–æ –ø—ñ–¥ –¥—ñ–∞–≥—Ä–∞–º—É (—â–æ –±—ñ–ª—å—à–µ)
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤–∏—Å–æ—Ç–∞ –¥—ñ–∞–≥—Ä–∞–º–∏ ~15 —Ä—è–¥–∫—ñ–≤.
            rows_occupied = max(n_rows + 3, 18)
            current_row += rows_occupied

    return output.getvalue()

////////////////////////////////////////////////////////////////////////////////////////////////

"""
–ú–æ–¥—É–ª—å —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è Excel-–∑–≤—ñ—Ç—É –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.

–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—ñ–≤ —É —Ñ–æ—Ä–º–∞—Ç—ñ XLSX –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–∞–∫—Ç–∏—Ü—ñ –¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞–Ω–Ω—è
—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —Å–æ—Ü—ñ–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å —É –ó–í–û —Ç–∞ –≤–∏–º–æ–≥–∞–º –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö
—Å–∏—Å—Ç–µ–º –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —è–∫–æ—Å—Ç—ñ –æ—Å–≤—ñ—Ç–∏.
"""

from __future__ import annotations

import io
from typing import Dict, List

import pandas as pd
import xlsxwriter

from classification import QuestionInfo, QuestionType
from summary import QuestionSummary


def build_excel_report(
    original_df: pd.DataFrame,
    sliced_df: pd.DataFrame,
    qinfo: Dict[str, QuestionInfo],
    summaries: List[QuestionSummary],
    range_info: str,
) -> bytes:
    """
    –°—Ç–≤–æ—Ä—é—î Excel-–∑–≤—ñ—Ç —Ç–∞ –ø–æ–≤–µ—Ä—Ç–∞—î –π–æ–≥–æ —É –≤–∏–≥–ª—è–¥—ñ –±–∞–π—Ç—ñ–≤ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
    –î–æ–¥–∞—î –¥—ñ–∞–≥—Ä–∞–º–∏ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.

    :param original_df: –ø–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π.
    :param sliced_df: –≤–∏–±—Ä–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –¥—ñ–∞–ø–∞–∑–æ–Ω.
    :param qinfo: —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∏—Ç–∞–Ω–Ω—è.
    :param summaries: —Å–ø–∏—Å–æ–∫ –∑–≤–µ–¥–µ–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å.
    :param range_info: —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å –¥—ñ–∞–ø–∞–∑–æ–Ω—É (–¥–ª—è —Ç–∏—Ç—É–ª—É).
    """
    output = io.BytesIO()

    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ engine="xlsxwriter" –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥—ñ–∞–≥—Ä–∞–º
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        workbook = writer.book

        # –°—Ç–∏–ª—ñ
        header_fmt = workbook.add_format({"bold": True, "font_size": 11})
        title_fmt = workbook.add_format({"bold": True, "font_size": 12, "fg_color": "#DCE6F1"})
        
        # ---------------------------------------------------------
        # 1. –¢–µ—Ö–Ω—ñ—á–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
        # ---------------------------------------------------------
        meta_df = pd.DataFrame(
            {
                "–ü–∞—Ä–∞–º–µ—Ç—Ä": [
                    "–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–Ω–∫–µ—Ç —É —Ñ–∞–π–ª—ñ",
                    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–Ω–∫–µ—Ç —É –≤–∏–±—Ä–∞–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ",
                    "–î—ñ–∞–ø–∞–∑–æ–Ω –æ–±—Ä–æ–±–∫–∏",
                ],
                "–ó–Ω–∞—á–µ–Ω–Ω—è": [
                    len(original_df),
                    len(sliced_df),
                    range_info,
                ],
            }
        )
        meta_df.to_excel(writer, sheet_name="–¢–µ—Ö–Ω—ñ—á–Ω–∞_—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", index=False)
        
        # –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è —Ç–µ—Ö–Ω—ñ—á–Ω–æ–≥–æ –∞—Ä–∫—É—à–∞
        ws_meta = writer.sheets["–¢–µ—Ö–Ω—ñ—á–Ω–∞_—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è"]
        ws_meta.set_column(0, 0, 40)
        ws_meta.set_column(1, 1, 50)

        # ---------------------------------------------------------
        # 2. –í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (—Å–∫–æ—Ä–æ—á–µ–Ω–æ)
        # ---------------------------------------------------------
        sliced_df.to_excel(writer, sheet_name="–í–∏—Ö—ñ–¥–Ω—ñ_–¥–∞–Ω—ñ", index=False)

        # ---------------------------------------------------------
        # 3. –¢–∞–±–ª–∏—Ü—ñ –ø—ñ–¥—Å—É–º–∫—ñ–≤ —Ç–∞ –¥—ñ–∞–≥—Ä–∞–º–∏
        # ---------------------------------------------------------
        sheet_name = "–ü—ñ–¥—Å—É–º–∫–∏"
        # –°—Ç–≤–æ—Ä—é—î–º–æ –∞—Ä–∫—É—à –≤—Ä—É—á–Ω—É, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ–±'—î–∫—Ç worksheet
        worksheet = workbook.add_worksheet(sheet_name)
        writer.sheets[sheet_name] = worksheet

        # –ü–æ—Ç–æ—á–Ω–∏–π —Ä—è–¥–æ–∫ –¥–ª—è –∑–∞–ø–∏—Å—É
        current_row = 0

        for qs in summaries:
            # -- 3.1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∏—Ç–∞–Ω–Ω—è --
            q_title = f"{qs.question.code}. {qs.question.text}"
            worksheet.write(current_row, 0, q_title, title_fmt)
            current_row += 1

            # –Ø–∫—â–æ —Ç–∞–±–ª–∏—Ü—è –ø–æ—Ä–æ–∂–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤—ñ–¥–∫—Ä–∏—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–µ–º–∞—î –¥–∞–Ω–∏—Ö)
            if qs.table.empty:
                worksheet.write(current_row, 0, "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–±–æ —Ç–µ–∫—Å—Ç–æ–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.")
                current_row += 3
                continue

            # -- 3.2. –ó–∞–ø–∏—Å —Ç–∞–±–ª–∏—Ü—ñ –¥–∞–Ω–∏—Ö --
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ pandas to_excel –¥–ª—è –∑–∞–ø–∏—Å—É —Ç–∞–±–ª–∏—Ü—ñ —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –ø–æ–∑–∏—Ü—ñ—é
            qs.table.to_excel(
                writer,
                sheet_name=sheet_name,
                startrow=current_row,
                startcol=0,
                index=False,
                header=True,
            )

            # –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–∞–Ω–∏—Ö –¥–ª—è –¥—ñ–∞–≥—Ä–∞–º–∏
            # –¢–∞–±–ª–∏—Ü—è –º–∞—î –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ç–æ–º—É –¥–∞–Ω—ñ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ row+1
            n_items = len(qs.table)
            data_start_row = current_row + 1
            data_end_row = current_row + n_items

            # –ö–æ–ª–æ–Ω–∫–∏: A=0 (–í–∞—Ä—ñ–∞–Ω—Ç), B=1 (–ö—ñ–ª—å–∫—ñ—Å—Ç—å), C=2 (%)
            # –°–∏–Ω—Ç–∞–∫—Å–∏—Å xlsxwriter –¥–ª—è —Å–µ—Ä—ñ–π: [sheetname, first_row, first_col, last_row, last_col]
            categories_ref = [sheet_name, data_start_row, 0, data_end_row, 0]
            values_ref = [sheet_name, data_start_row, 1, data_end_row, 1]

            # -- 3.3. –ü–æ–±—É–¥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∏ --
            # –õ–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –¥—ñ–∞–≥—Ä–∞–º–∏
            if qs.question.qtype == QuestionType.SCALE:
                # –î–ª—è —à–∫–∞–ª–∏ 1-5 –∫—Ä–∞—â–µ —Å—Ç–æ–≤–ø—á–∏–∫–æ–≤–∞
                chart_type = 'column'
            else:
                # –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π/—Ç–∞–∫-–Ω—ñ - –∫—Ä—É–≥–æ–≤–∞
                chart_type = 'pie'

            chart = workbook.add_chart({'type': chart_type})

            chart.add_series({
                'name':       '–ö—ñ–ª—å–∫—ñ—Å—Ç—å',
                'categories': categories_ref,
                'values':     values_ref,
                'data_labels': {'value': True, 'percentage': (chart_type == 'pie')},
            })

            chart.set_title({'name': qs.question.code})
            chart.set_style(10) # –ü—Ä–∏—î–º–Ω–∏–π —Å—Ç–∏–ª—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            
            # –Ø–∫—â–æ –¥—ñ–∞–≥—Ä–∞–º–∞ —Å—Ç–æ–≤–ø—á–∏–∫–æ–≤–∞, –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ª–µ–≥–µ–Ω–¥—É (–≤–æ–Ω–∞ –¥—É–±–ª—é—î –≤—ñ—Å—å X)
            if chart_type == 'column':
                 chart.set_legend({'position': 'none'})
                 chart.set_x_axis({'name': '–í–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ'})
                 chart.set_y_axis({'name': '–ö—ñ–ª—å–∫—ñ—Å—Ç—å'})

            # –í—Å—Ç–∞–≤–∫–∞ –¥—ñ–∞–≥—Ä–∞–º–∏ –ø—Ä–∞–≤—ñ—à–µ –≤—ñ–¥ —Ç–∞–±–ª–∏—Ü—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–ª–æ–Ω–∫–∞ E, —ñ–Ω–¥–µ–∫—Å 4)
            # –ó–º—ñ—â–µ–Ω–Ω—è –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—ñ, —â–æ–± –≤–∏—Ä—ñ–≤–Ω—è—Ç–∏ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –ø–∏—Ç–∞–Ω–Ω—è
            worksheet.insert_chart(current_row - 1, 4, chart)

            # -- 3.4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ —Ä—è–¥–∫—ñ–≤ --
            # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å—Ç—É–ø—É: –±–µ—Ä–µ–º–æ –º–∞–∫—Å–∏–º—É–º –º—ñ–∂ –≤–∏—Å–æ—Ç–æ—é —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ –≤–∏—Å–æ—Ç–æ—é –¥—ñ–∞–≥—Ä–∞–º–∏
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤–∏—Å–æ—Ç–∞ –¥—ñ–∞–≥—Ä–∞–º–∏ –≤ Excel ~ 15 —Ä—è–¥–∫—ñ–≤
            block_height = max(n_items + 2, 18)
            current_row += block_height + 1  # +1 –¥–ª—è –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ —Ä—è–¥–∫–∞ –º—ñ–∂ –±–ª–æ–∫–∞–º–∏

        # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ –ø–µ—Ä—à–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ
        worksheet.set_column(0, 0, 45) # –í–∞—Ä—ñ–∞–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
        worksheet.set_column(1, 2, 10) # –ß–∏—Å–ª–∞

    return output.getvalue()


===========================================================


    # --- –ï–∫—Å–ø–æ—Ä—Ç –∑–≤—ñ—Ç—É ---
        st.subheader("–ï–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤")
        range_info = f"–†—è–¥–∫–∏ {st.session_state.from_row}‚Äì{st.session_state.to_row} (—É—Å—å–æ–≥–æ {len(sliced)} –∞–Ω–∫–µ—Ç)"

        # --- –§—É–Ω–∫—Ü—ñ—ó –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º (—â–æ–± –Ω–µ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ –±–µ–∑ –∑–º—ñ–Ω) ---
        # show_spinner=True –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–∫–∞–∑—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ì–µ–Ω–µ—Ä—É—î–º–æ..." –ø—ñ–¥ —á–∞—Å —Ä–æ–±–æ—Ç–∏
        
        @st.cache_data(show_spinner="–ì–µ–Ω–µ—Ä—É—î–º–æ PDF-–∑–≤—ñ—Ç (—Ü–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ —á–∞—Å)...")
        def get_pdf_data(_original_df, _sliced_df, _summaries, _range_info):
            return build_pdf_report(_original_df, _sliced_df, _summaries, _range_info)

        @st.cache_data(show_spinner="–ì–µ–Ω–µ—Ä—É—î–º–æ Word-–∑–≤—ñ—Ç...")
        def get_docx_data(_original_df, _sliced_df, _summaries, _range_info):
            return build_docx_report(_original_df, _sliced_df, _summaries, _range_info)

        @st.cache_data(show_spinner="–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ Excel-—Ç–∞–±–ª–∏—Ü—å...")
        def get_excel_data(_original_df, _sliced_df, _qinfo, _summaries, _range_info):
            return build_excel_report(_original_df, _sliced_df, _qinfo, _summaries, _range_info)

        # --- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ñ–∞–π–ª—ñ–≤ (–≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –¥–∞–Ω–∏—Ö) ---
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –∑ –Ω–∏–∂–Ω—ñ–º –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è–º (_), —â–æ–± Streamlit –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–µ—à—É–≤–∞–≤ —Å–∫–ª–∞–¥–Ω—ñ –æ–±'—î–∫—Ç–∏
        
        # 1. Excel
        excel_bytes = get_excel_data(
            st.session_state.ld.df,
            st.session_state.sliced,
            st.session_state.qinfo,
            st.session_state.summaries,
            range_info
        )

        # 2. PDF
        pdf_bytes = get_pdf_data(
            st.session_state.ld.df,
            st.session_state.sliced,
            st.session_state.summaries,
            range_info
        )
        
        # 3. Word
        docx_bytes = get_docx_data(
            st.session_state.ld.df,
            st.session_state.sliced,
            st.session_state.summaries,
            range_info
        )

        # --- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è 3 –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥ ---
        col1, col2, col3 = st.columns(3)

        with col1:
            st.download_button(
                label="üì• Excel —Ç–∞–±–ª–∏—Ü—è",
                data=excel_bytes,
                file_name="survey_results.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True
            )

        with col2:
            st.download_button(
                label="üì• PDF –ó–≤—ñ—Ç",
                data=pdf_bytes,
                file_name="survey_results.pdf",
                mime="application/pdf",
                use_container_width=True
            )

        with col3:
            st.download_button(
                label="üì• Word –ó–≤—ñ—Ç",
                data=docx_bytes,
                file_name="survey_results.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                use_container_width=True
            )